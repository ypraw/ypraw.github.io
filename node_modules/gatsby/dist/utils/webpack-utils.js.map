{"version":3,"sources":["../../src/utils/webpack-utils.js"],"names":["autoprefixer","require","flexbugs","TerserPlugin","MiniCssExtractPlugin","OptimizeCssAssetsPlugin","isWsl","GatsbyWebpackStatsExtractor","builtinPlugins","eslintConfig","module","exports","stage","program","assetRelativeRoot","vendorRegex","supportedBrowsers","browserslist","PRODUCTION","includes","isSSR","makeExternalOnly","original","options","rule","include","makeInternalOnly","exclude","ident","loaders","json","loader","resolve","yaml","null","raw","style","miniCssExtract","css","sourceMap","camelCase","localIdentName","postcss","plugins","overrideBrowserslist","postcssOpts","flexbox","file","name","url","limit","js","eslint","schema","imports","rules","test","use","mjs","type","enforce","fonts","images","media","miscAssets","browsers","importLoaders","unshift","hmr","modules","internal","external","cssModules","minifyJs","terserOptions","cache","parallel","ie8","mangle","safari10","parse","ecma","compress","output","minifyCss","extractText","filename","chunkFilename","moment","ignore","extractStats"],"mappings":"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","sourcesContent":["// @flow\n\nconst autoprefixer = require(`autoprefixer`)\nconst flexbugs = require(`postcss-flexbugs-fixes`)\nconst TerserPlugin = require(`terser-webpack-plugin`)\nconst MiniCssExtractPlugin = require(`mini-css-extract-plugin`)\nconst OptimizeCssAssetsPlugin = require(`optimize-css-assets-webpack-plugin`)\nconst isWsl = require(`is-wsl`)\n\nconst GatsbyWebpackStatsExtractor = require(`./gatsby-webpack-stats-extractor`)\n\nconst builtinPlugins = require(`./webpack-plugins`)\nconst eslintConfig = require(`./eslint-config`)\n\ntype LoaderSpec = string | { loader: string, options?: Object }\ntype LoaderResolver<T: Object> = (options?: T) => LoaderSpec\n\ntype Condition = string | RegExp | RegExp[]\n\ntype Rule = {\n  test?: Condition,\n  use: LoaderSpec[],\n  exclude?: Condition,\n  include?: Condition,\n}\n\ntype RuleFactory<T: Object> = (options?: T) => Rule\n\ntype ContextualRuleFactory = RuleFactory<*> & {\n  internal: RuleFactory<*>,\n  external: RuleFactory<*>,\n}\n\ntype PluginInstance = any\ntype PluginFactory = (...args?: any) => PluginInstance\n\ntype BuiltinPlugins = typeof builtinPlugins\n\ntype Stage = \"develop\" | \"develop-html\" | \"build-javascript\" | \"build-html\"\n\n/**\n * Configuration options for `createUtils`\n */\nexport type WebpackUtilsOptions = { stage: Stage, program: any }\n\n/**\n * Utils that produce webpack `loader` objects\n */\nexport type LoaderUtils = {\n  json: LoaderResolver<*>,\n  yaml: LoaderResolver<*>,\n  null: LoaderResolver<*>,\n  raw: LoaderResolver<*>,\n\n  style: LoaderResolver<*>,\n  css: LoaderResolver<*>,\n  postcss: LoaderResolver<{\n    browsers?: string[],\n    plugins?: Array<any> | ((loader: any) => Array<any>),\n  }>,\n\n  file: LoaderResolver<*>,\n  url: LoaderResolver<*>,\n  js: LoaderResolver<*>,\n\n  miniCssExtract: LoaderResolver<*>,\n  imports: LoaderResolver<*>,\n  exports: LoaderResolver<*>,\n\n  eslint: LoaderResolver<*>,\n}\n\n/**\n * Utils that produce webpack rule objects\n */\nexport type RuleUtils = {\n  /**\n   * Handles JavaScript compilation via babel\n   */\n  js: RuleFactory<*>,\n  yaml: RuleFactory<*>,\n  fonts: RuleFactory<*>,\n  images: RuleFactory<*>,\n  miscAssets: RuleFactory<*>,\n\n  css: ContextualRuleFactory,\n  cssModules: RuleFactory<*>,\n  postcss: ContextualRuleFactory,\n\n  eslint: RuleFactory<*>,\n}\n\nexport type PluginUtils = BuiltinPlugins & {\n  extractText: PluginFactory,\n  uglify: PluginFactory,\n  moment: PluginFactory,\n  extractStats: PluginFactory,\n}\n\n/**\n * webpack atoms namespace\n */\nexport type WebpackUtils = {\n  loaders: LoaderUtils,\n\n  rules: RuleUtils,\n\n  plugins: PluginUtils,\n}\n\n/**\n * A factory method that produces an atoms namespace\n */\nmodule.exports = async ({\n  stage,\n  program,\n}: {\n  stage: Stage,\n  program: any,\n}): Promise<WebpackUtilsOptions> => {\n  const assetRelativeRoot = `static/`\n  const vendorRegex = /(node_modules|bower_components)/\n  const supportedBrowsers = program.browserslist\n\n  const PRODUCTION = !stage.includes(`develop`)\n\n  const isSSR = stage.includes(`html`)\n\n  const makeExternalOnly = (original: RuleFactory<*>) => (\n    options = {}\n  ): Rule => {\n    let rule = original(options)\n    rule.include = vendorRegex\n    return rule\n  }\n\n  const makeInternalOnly = (original: RuleFactory<*>) => (\n    options = {}\n  ): Rule => {\n    let rule = original(options)\n    rule.exclude = vendorRegex\n    return rule\n  }\n\n  let ident = 0\n\n  const loaders: LoaderUtils = {\n    json: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`json-loader`),\n      }\n    },\n\n    yaml: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`yaml-loader`),\n      }\n    },\n\n    null: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`null-loader`),\n      }\n    },\n\n    raw: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`raw-loader`),\n      }\n    },\n\n    style: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`style-loader`),\n      }\n    },\n\n    miniCssExtract: (options = {}) => {\n      return {\n        options,\n        // use MiniCssExtractPlugin only on production builds\n        loader: PRODUCTION\n          ? MiniCssExtractPlugin.loader\n          : require.resolve(`style-loader`),\n      }\n    },\n\n    css: (options = {}) => {\n      return {\n        loader: isSSR\n          ? require.resolve(`css-loader/locals`)\n          : require.resolve(`css-loader`),\n        options: {\n          sourceMap: !PRODUCTION,\n          camelCase: `dashesOnly`,\n          // https://github.com/webpack-contrib/css-loader/issues/406\n          localIdentName: `[name]--[local]--[hash:base64:5]`,\n          ...options,\n        },\n      }\n    },\n\n    postcss: (options = {}) => {\n      let {\n        plugins,\n        overrideBrowserslist = supportedBrowsers,\n        ...postcssOpts\n      } = options\n\n      return {\n        loader: require.resolve(`postcss-loader`),\n        options: {\n          ident: `postcss-${++ident}`,\n          sourceMap: !PRODUCTION,\n          plugins: loader => {\n            plugins =\n              (typeof plugins === `function` ? plugins(loader) : plugins) || []\n\n            return [\n              flexbugs,\n              autoprefixer({ overrideBrowserslist, flexbox: `no-2009` }),\n              ...plugins,\n            ]\n          },\n          ...postcssOpts,\n        },\n      }\n    },\n\n    file: (options = {}) => {\n      return {\n        loader: require.resolve(`file-loader`),\n        options: {\n          name: `${assetRelativeRoot}[name]-[hash].[ext]`,\n          ...options,\n        },\n      }\n    },\n\n    url: (options = {}) => {\n      return {\n        loader: require.resolve(`url-loader`),\n        options: {\n          limit: 10000,\n          name: `${assetRelativeRoot}[name]-[hash].[ext]`,\n          ...options,\n        },\n      }\n    },\n\n    js: options => {\n      return {\n        options,\n        loader: require.resolve(`./babel-loader`),\n      }\n    },\n\n    eslint: (schema = ``) => {\n      const options = eslintConfig(schema)\n\n      return {\n        options,\n        loader: require.resolve(`eslint-loader`),\n      }\n    },\n\n    imports: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`imports-loader`),\n      }\n    },\n\n    exports: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`exports-loader`),\n      }\n    },\n  }\n\n  /**\n   * Rules\n   */\n  const rules = {}\n\n  /**\n   * JavaScript loader via babel, excludes node_modules\n   */\n  {\n    let js = (options = {}) => {\n      return {\n        test: /\\.jsx?$/,\n        exclude: vendorRegex,\n        use: [loaders.js(options)],\n      }\n    }\n\n    rules.js = js\n  }\n\n  /**\n   * mjs loader:\n   * webpack 4 has issues automatically dealing with\n   * the .mjs extension, thus we need to explicitly\n   * add this rule to use the default webpack js loader\n   */\n  {\n    let mjs = (options = {}) => {\n      return {\n        test: /\\.mjs$/,\n        include: /node_modules/,\n        type: `javascript/auto`,\n        ...options,\n      }\n    }\n\n    rules.mjs = mjs\n  }\n\n  {\n    let eslint = schema => {\n      return {\n        enforce: `pre`,\n        test: /\\.jsx?$/,\n        exclude: vendorRegex,\n        use: [loaders.eslint(schema)],\n      }\n    }\n\n    rules.eslint = eslint\n  }\n\n  rules.yaml = () => {\n    return {\n      test: /\\.ya?ml/,\n      use: [loaders.json(), loaders.yaml()],\n    }\n  }\n\n  /**\n   * Font loader\n   */\n  rules.fonts = () => {\n    return {\n      use: [loaders.url()],\n      test: /\\.(eot|otf|ttf|woff(2)?)(\\?.*)?$/,\n    }\n  }\n\n  /**\n   * Loads image assets, inlines images via a data URI if they are below\n   * the size threshold\n   */\n  rules.images = () => {\n    return {\n      use: [loaders.url()],\n      test: /\\.(ico|svg|jpg|jpeg|png|gif|webp)(\\?.*)?$/,\n    }\n  }\n\n  /**\n   * Loads audio and video and inlines them via a data URI if they are below\n   * the size threshold\n   */\n  rules.media = () => {\n    return {\n      use: [loaders.url()],\n      test: /\\.(mp4|webm|ogv|wav|mp3|m4a|aac|oga|flac)$/,\n    }\n  }\n\n  /**\n   * Loads assets without inlining\n   */\n  rules.miscAssets = () => {\n    return {\n      use: [loaders.file()],\n      test: /\\.pdf$/,\n    }\n  }\n\n  /**\n   * CSS style loader.\n   */\n  {\n    const css = ({ browsers, ...options } = {}) => {\n      const use = [\n        loaders.css({ ...options, importLoaders: 1 }),\n        loaders.postcss({ browsers }),\n      ]\n      if (!isSSR) use.unshift(loaders.miniCssExtract({ hmr: !options.modules }))\n\n      return {\n        use,\n        test: /\\.css$/,\n      }\n    }\n\n    /**\n     * CSS style loader, _excludes_ node_modules.\n     */\n    css.internal = makeInternalOnly(css)\n    css.external = makeExternalOnly(css)\n\n    const cssModules = options => {\n      const rule = css({ ...options, modules: true })\n      delete rule.exclude\n      rule.test = /\\.module\\.css$/\n      return rule\n    }\n\n    rules.css = css\n    rules.cssModules = cssModules\n  }\n\n  /**\n   * PostCSS loader.\n   */\n  {\n    const postcss = options => {\n      return {\n        test: /\\.css$/,\n        use: [loaders.css({ importLoaders: 1 }), loaders.postcss(options)],\n      }\n    }\n\n    /**\n     * PostCSS loader, _excludes_ node_modules.\n     */\n    postcss.internal = makeInternalOnly(postcss)\n    postcss.external = makeExternalOnly(postcss)\n    rules.postcss = postcss\n  }\n  /**\n   * Plugins\n   */\n  const plugins = { ...builtinPlugins }\n\n  /**\n   * Minify JavaScript code without regard for IE8. Attempts\n   * to parallelize the work to save time. Generally only add in Production\n   */\n  plugins.minifyJs = ({ terserOptions, ...options } = {}) =>\n    new TerserPlugin({\n      cache: true,\n      // We can't use parallel in WSL because of https://github.com/gatsbyjs/gatsby/issues/6540\n      // This issue was fixed in https://github.com/gatsbyjs/gatsby/pull/12636\n      parallel: !isWsl,\n      exclude: /\\.min\\.js/,\n      sourceMap: true,\n      terserOptions: {\n        ie8: false,\n        mangle: {\n          safari10: true,\n        },\n        parse: {\n          ecma: 8,\n        },\n        compress: {\n          ecma: 5,\n        },\n        output: {\n          ecma: 5,\n        },\n        ...terserOptions,\n      },\n      ...options,\n    })\n\n  plugins.minifyCss = (options = {}) => new OptimizeCssAssetsPlugin(options)\n\n  /**\n   * Extracts css requires into a single file;\n   * includes some reasonable defaults\n   */\n  plugins.extractText = options =>\n    new MiniCssExtractPlugin({\n      filename: `[name].[contenthash].css`,\n      chunkFilename: `[name].[contenthash].css`,\n      ...options,\n    })\n\n  plugins.moment = () => plugins.ignore(/^\\.\\/locale$/, /moment$/)\n\n  plugins.extractStats = options => new GatsbyWebpackStatsExtractor(options)\n\n  return {\n    loaders,\n    rules: (rules: RuleUtils),\n    plugins: (plugins: PluginUtils),\n  }\n}\n"],"file":"webpack-utils.js"}